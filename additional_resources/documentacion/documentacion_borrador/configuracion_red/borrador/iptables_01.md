
[victory@server terraform-openshift-kvm-deployment]$ cat /etc/iptables/rules.v4
# Generated by iptables-save v1.8.10 (nf_tables) on Wed May 22 20:19:36 2024
*mangle
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [3332:6338623]
:LIBVIRT_PRT - [0:0]
-A POSTROUTING -j LIBVIRT_PRT
-A LIBVIRT_PRT -o virbr1 -p udp -m udp --dport 68 -j CHECKSUM --checksum-fill
-A LIBVIRT_PRT -o virbr0 -p udp -m udp --dport 68 -j CHECKSUM --checksum-fill
COMMIT
# Completed on Wed May 22 20:19:36 2024
# Generated by iptables-save v1.8.10 (nf_tables) on Wed May 22 20:19:36 2024
*raw
:PREROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
COMMIT
# Completed on Wed May 22 20:19:36 2024
# Generated by iptables-save v1.8.10 (nf_tables) on Wed May 22 20:19:36 2024
*filter
:INPUT ACCEPT [4781:455805]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [3330:6338471]
:LIBVIRT_FWI - [0:0]
:LIBVIRT_FWO - [0:0]
:LIBVIRT_FWX - [0:0]
:LIBVIRT_INP - [0:0]
:LIBVIRT_OUT - [0:0]
-A INPUT -j LIBVIRT_INP
-A FORWARD -j LIBVIRT_FWX
-A FORWARD -j LIBVIRT_FWI
-A FORWARD -j LIBVIRT_FWO
-A OUTPUT -j LIBVIRT_OUT
-A LIBVIRT_FWI -d 10.17.4.0/24 -o virbr1 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A LIBVIRT_FWI -o virbr1 -j REJECT --reject-with icmp-port-unreachable
-A LIBVIRT_FWI -d 10.17.3.0/24 -o virbr0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A LIBVIRT_FWI -o virbr0 -j REJECT --reject-with icmp-port-unreachable
-A LIBVIRT_FWO -s 10.17.4.0/24 -i virbr1 -j ACCEPT
-A LIBVIRT_FWO -i virbr1 -j REJECT --reject-with icmp-port-unreachable
-A LIBVIRT_FWO -s 10.17.3.0/24 -i virbr0 -j ACCEPT
-A LIBVIRT_FWO -i virbr0 -j REJECT --reject-with icmp-port-unreachable
-A LIBVIRT_FWX -i virbr1 -o virbr1 -j ACCEPT
-A LIBVIRT_FWX -i virbr0 -o virbr0 -j ACCEPT
-A LIBVIRT_INP -i virbr1 -p udp -m udp --dport 53 -j ACCEPT
-A LIBVIRT_INP -i virbr1 -p tcp -m tcp --dport 53 -j ACCEPT
-A LIBVIRT_INP -i virbr1 -p udp -m udp --dport 67 -j ACCEPT
-A LIBVIRT_INP -i virbr1 -p tcp -m tcp --dport 67 -j ACCEPT
-A LIBVIRT_INP -i virbr0 -p udp -m udp --dport 53 -j ACCEPT
-A LIBVIRT_INP -i virbr0 -p tcp -m tcp --dport 53 -j ACCEPT
-A LIBVIRT_INP -i virbr0 -p udp -m udp --dport 67 -j ACCEPT
-A LIBVIRT_INP -i virbr0 -p tcp -m tcp --dport 67 -j ACCEPT
-A LIBVIRT_OUT -o virbr1 -p udp -m udp --dport 53 -j ACCEPT
-A LIBVIRT_OUT -o virbr1 -p tcp -m tcp --dport 53 -j ACCEPT
-A LIBVIRT_OUT -o virbr1 -p udp -m udp --dport 68 -j ACCEPT
-A LIBVIRT_OUT -o virbr1 -p tcp -m tcp --dport 68 -j ACCEPT
-A LIBVIRT_OUT -o virbr0 -p udp -m udp --dport 53 -j ACCEPT
-A LIBVIRT_OUT -o virbr0 -p tcp -m tcp --dport 53 -j ACCEPT
-A LIBVIRT_OUT -o virbr0 -p udp -m udp --dport 68 -j ACCEPT
-A LIBVIRT_OUT -o virbr0 -p tcp -m tcp --dport 68 -j ACCEPT
COMMIT
# Completed on Wed May 22 20:19:36 2024
# Generated by iptables-save v1.8.10 (nf_tables) on Wed May 22 20:19:36 2024
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:LIBVIRT_PRT - [0:0]
-A POSTROUTING -j LIBVIRT_PRT
-A LIBVIRT_PRT -s 10.17.4.0/24 -d 224.0.0.0/24 -j RETURN
-A LIBVIRT_PRT -s 10.17.4.0/24 -d 255.255.255.255/32 -j RETURN
-A LIBVIRT_PRT -s 10.17.4.0/24 ! -d 10.17.4.0/24 -p tcp -j MASQUERADE --to-ports 1024-65535
-A LIBVIRT_PRT -s 10.17.4.0/24 ! -d 10.17.4.0/24 -p udp -j MASQUERADE --to-ports 1024-65535
-A LIBVIRT_PRT -s 10.17.4.0/24 ! -d 10.17.4.0/24 -j MASQUERADE
-A LIBVIRT_PRT -s 10.17.3.0/24 -d 224.0.0.0/24 -j RETURN
-A LIBVIRT_PRT -s 10.17.3.0/24 -d 255.255.255.255/32 -j RETURN
-A LIBVIRT_PRT -s 10.17.3.0/24 ! -d 10.17.3.0/24 -p tcp -j MASQUERADE --to-ports 1024-65535
-A LIBVIRT_PRT -s 10.17.3.0/24 ! -d 10.17.3.0/24 -p udp -j MASQUERADE --to-ports 1024-65535
-A LIBVIRT_PRT -s 10.17.3.0/24 ! -d 10.17.3.0/24 -j MASQUERADE
COMMIT

# Completed on Wed May 22 20:19:36 2024

[victory@server terraform-openshift-kvm-deployment]$





# Generated by iptables-save v1.8.10 (nf_tables) on Wed May 22 20:26:27 2024
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:LIBVIRT_PRT - [0:0]
-A POSTROUTING -j LIBVIRT_PRT
-A LIBVIRT_PRT -o virbr1 -p udp -m udp --dport 68 -j CHECKSUM --checksum-fill
-A LIBVIRT_PRT -o virbr0 -p udp -m udp --dport 68 -j CHECKSUM --checksum-fill
COMMIT
# Completed on Wed May 22 20:26:27 2024
# Generated by iptables-save v1.8.10 (nf_tables) on Wed May 22 20:26:27 2024
*raw
:PREROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
COMMIT
# Completed on Wed May 22 20:26:27 2024
# Generated by iptables-save v1.8.10 (nf_tables) on Wed May 22 20:26:27 2024
*filter
:INPUT ACCEPT [21432:1751797]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [18585:23591382]
:LIBVIRT_FWI - [0:0]
:LIBVIRT_FWO - [0:0]
:LIBVIRT_FWX - [0:0]
:LIBVIRT_INP - [0:0]
:LIBVIRT_OUT - [0:0]
-A INPUT -j LIBVIRT_INP
-A FORWARD -j LIBVIRT_FWX
-A FORWARD -j LIBVIRT_FWI
-A FORWARD -j LIBVIRT_FWO
-A OUTPUT -j LIBVIRT_OUT
-A LIBVIRT_FWI -d 10.17.4.0/24 -o virbr1 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A LIBVIRT_FWI -o virbr1 -j REJECT --reject-with icmp-port-unreachable
-A LIBVIRT_FWI -d 10.17.3.0/24 -o virbr0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A LIBVIRT_FWI -o virbr0 -j REJECT --reject-with icmp-port-unreachable
-A LIBVIRT_FWO -s 10.17.4.0/24 -i virbr1 -j ACCEPT
-A LIBVIRT_FWO -i virbr1 -j REJECT --reject-with icmp-port-unreachable
-A LIBVIRT_FWO -s 10.17.3.0/24 -i virbr0 -j ACCEPT
-A LIBVIRT_FWO -i virbr0 -j REJECT --reject-with icmp-port-unreachable
-A LIBVIRT_FWX -i virbr1 -o virbr1 -j ACCEPT
-A LIBVIRT_FWX -i virbr0 -o virbr0 -j ACCEPT
-A LIBVIRT_INP -i virbr1 -p udp -m udp --dport 53 -j ACCEPT
-A LIBVIRT_INP -i virbr1 -p tcp -m tcp --dport 53 -j ACCEPT
-A LIBVIRT_INP -i virbr1 -p udp -m udp --dport 67 -j ACCEPT
-A LIBVIRT_INP -i virbr1 -p tcp -m tcp --dport 67 -j ACCEPT
-A LIBVIRT_INP -i virbr0 -p udp -m udp --dport 53 -j ACCEPT
-A LIBVIRT_INP -i virbr0 -p tcp -m tcp --dport 53 -j ACCEPT
-A LIBVIRT_INP -i virbr0 -p udp -m udp --dport 67 -j ACCEPT
-A LIBVIRT_INP -i virbr0 -p tcp -m tcp --dport 67 -j ACCEPT
-A LIBVIRT_OUT -o virbr1 -p udp -m udp --dport 53 -j ACCEPT
-A LIBVIRT_OUT -o virbr1 -p tcp -m tcp --dport 53 -j ACCEPT
-A LIBVIRT_OUT -o virbr1 -p udp -m udp --dport 68 -j ACCEPT
-A LIBVIRT_OUT -o virbr1 -p tcp -m tcp --dport 68 -j ACCEPT
-A LIBVIRT_OUT -o virbr0 -p udp -m udp --dport 53 -j ACCEPT
-A LIBVIRT_OUT -o virbr0 -p tcp -m tcp --dport 53 -j ACCEPT
-A LIBVIRT_OUT -o virbr0 -p udp -m udp --dport 68 -j ACCEPT
-A LIBVIRT_OUT -o virbr0 -p tcp -m tcp --dport 68 -j ACCEPT
COMMIT
# Completed on Wed May 22 20:26:27 2024
# Generated by iptables-save v1.8.10 (nf_tables) on Wed May 22 20:26:27 2024
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:LIBVIRT_PRT - [0:0]
-A POSTROUTING -j LIBVIRT_PRT
-A LIBVIRT_PRT -s 10.17.4.0/24 -d 224.0.0.0/24 -j RETURN
-A LIBVIRT_PRT -s 10.17.4.0/24 -d 255.255.255.255/32 -j RETURN
-A LIBVIRT_PRT -s 10.17.4.0/24 ! -d 10.17.4.0/24 -p tcp -j MASQUERADE --to-ports 1024-65535
-A LIBVIRT_PRT -s 10.17.4.0/24 ! -d 10.17.4.0/24 -p udp -j MASQUERADE --to-ports 1024-65535
-A LIBVIRT_PRT -s 10.17.4.0/24 ! -d 10.17.4.0/24 -j MASQUERADE
-A LIBVIRT_PRT -s 10.17.3.0/24 -d 224.0.0.0/24 -j RETURN
-A LIBVIRT_PRT -s 10.17.3.0/24 -d 255.255.255.255/32 -j RETURN
-A LIBVIRT_PRT -s 10.17.3.0/24 ! -d 10.17.3.0/24 -p tcp -j MASQUERADE --to-ports 1024-65535
-A LIBVIRT_PRT -s 10.17.3.0/24 ! -d 10.17.3.0/24 -p udp -j MASQUERADE --to-ports 1024-65535
-A LIBVIRT_PRT -s 10.17.3.0/24 ! -d 10.17.3.0/24 -j MASQUERADE
COMMIT
# Completed on Wed May 22 20:26:27 2024

*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]

# Enmascaramiento para las redes NAT
-A POSTROUTING -s 10.17.3.0/24 -o enp3s0f1 -j MASQUERADE
-A POSTROUTING -s 10.17.4.0/24 -o enp3s0f1 -j MASQUERADE

COMMIT

*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]

# Permitir tráfico hacia y desde las redes NAT
-A FORWARD -i enp3s0f1 -o virbr0 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i enp3s0f1 -o virbr1 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i virbr0 -o enp3s0f1 -j ACCEPT
-A FORWARD -i virbr1 -o enp3s0f1 -j ACCEPT

# Permitir tráfico entre las redes NAT
-A FORWARD -i virbr0 -o virbr1 -j ACCEPT
-A FORWARD -i virbr1 -o virbr0 -j ACCEPT

COMMIT




[victory@cefaslocalserver ~]$ sudo cat /etc/iptables/rules.v4
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:LIBVIRT_FWI - [0:0]
:LIBVIRT_FWO - [0:0]
:LIBVIRT_FWX - [0:0]
:LIBVIRT_INP - [0:0]
:LIBVIRT_OUT - [0:0]

# Permitir tráfico loopback
-A INPUT -i lo -j ACCEPT
-A OUTPUT -o lo -j ACCEPT

# Permitir tráfico relacionado con conexiones existentes
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# Permitir tráfico SSH
-A INPUT -p tcp --dport 22 -j ACCEPT

# Permitir ICMPv6
-A INPUT -p ipv6-icmp -j ACCEPT

# Permitir tráfico DNS y DHCPv6
-A INPUT -p udp --dport 53 -j ACCEPT
-A INPUT -p tcp --dport 53 -j ACCEPT
-A INPUT -p udp --dport 546 -j ACCEPT
-A INPUT -p udp --dport 547 -j ACCEPT

# Reglas para nat_network_03 (2001:db8:2::/64)
-A LIBVIRT_FWI -d 2001:db8:2::/64 -o virbr1 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A LIBVIRT_FWI -o virbr1 -j REJECT --reject-with icmp6-port-unreachable
-A LIBVIRT_FWO -s 2001:db8:2::/64 -i virbr1 -j ACCEPT
-A LIBVIRT_FWO -i virbr1 -j REJECT --reject-with icmp6-port-unreachable
-A LIBVIRT_FWX -i virbr1 -o virbr1 -j ACCEPT

# Reglas para nat_network_02 (2001:db8:1::/64)
-A LIBVIRT_FWI -d 2001:db8:1::/64 -o virbr0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A LIBVIRT_FWI -o virbr0 -j REJECT --reject-with icmp6-port-unreachable
-A LIBVIRT_FWO -s 2001:db8:1::/64 -i virbr0 -j ACCEPT
-A LIBVIRT_FWO -i virbr0 -j REJECT --reject-with icmp6-port-unreachable
-A LIBVIRT_FWX -i virbr0 -o virbr0 -j ACCEPT

# Rechazar todo el resto del tráfico
-A INPUT -j REJECT
-A FORWARD -j REJECT
COMMIT

*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:LIBVIRT_PRT - [0:0]

# Enmascaramiento para las redes NAT
-A POSTROUTING -s 2001:db8:1::/64 -j MASQUERADE
-A POSTROUTING -s 2001:db8:2::/64 -j MASQUERADE
COMMIT
[victory@cefaslocalserver ~]$


sudo ip route del 10.17.3.0/24 via 192.168.0.1 dev eth0
sudo ip route del 10.17.4.0/24 via 192.168.0.1 dev eth0




sudo ip route add 10.17.3.0/24 via 192.168.0.30 dev eth0
sudo ip route add 10.17.4.0/24 via 192.168.0.30 dev eth0

sudo ip route add 10.17.3.0/24 via 192.168.0.1 dev eth0
sudo ip route add 10.17.4.0/24 via 192.168.0.1 dev eth0

sudo iptables-save | sudo tee  /etc/sysconfig/iptables



# En bootstrap1
sudo ip route add 10.17.3.0/24 via 10.17.4.1

# En freeipa1
sudo ip route add 10.17.4.0/24 via 10.17.3.1


ping -c 4 10.17.4.20
ping -c 4 10.17.3.11


sudo iptables-restore < /etc/sysconfig/iptables
sudo systemctl restart iptables
sudo systemctl enable iptables
sudo systemctl status iptables
