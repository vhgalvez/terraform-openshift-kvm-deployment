Instalación de iptables
Actualizar la lista de paquetes:

bash
Copiar código
sudo dnf update -y
Instalar iptables:

bash
Copiar código
sudo dnf install iptables iptables-services -y
Configuración del Servicio iptables
Crear el archivo de servicio para iptables:

bash
Copiar código
sudo nano /usr/lib/systemd/system/iptables.service
Agregar el siguiente contenido al archivo de servicio:

ini
Copiar código
[Unit]
Description=IPv4 firewall with iptables
AssertPathExists=/etc/sysconfig/iptables
Before=network-pre.target
Wants=network-pre.target

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/libexec/iptables/iptables.init start
ExecReload=/usr/libexec/iptables/iptables.init reload
ExecStop=/usr/libexec/iptables/iptables.init stop
Environment=BOOTUP=serial
Environment=CONSOLETYPE=serial

[Install]
WantedBy=multi-user.target
Guardar y cerrar el archivo.

Creación del Archivo de Configuración de iptables
Crear el archivo de configuración iptables:

bash
Copiar código
sudo nano /etc/sysconfig/iptables
Agregar las reglas necesarias al archivo de configuración:

plaintext
Copiar código
# Generated by iptables-save v1.8.10 (nf_tables) on Wed May 22 20:26:27 2024
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:LIBVIRT_PRT - [0:0]
-A POSTROUTING -j LIBVIRT_PRT
-A LIBVIRT_PRT -o virbr1 -p udp -m udp --dport 68 -j CHECKSUM --checksum-fill
-A LIBVIRT_PRT -o virbr0 -p udp -m udp --dport 68 -j CHECKSUM --checksum-fill
COMMIT
# Completed on Wed May 22 20:26:27 2024
# Generated by iptables-save v1.8.10 (nf_tables) on Wed May 22 20:26:27 2024
*raw
:PREROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
COMMIT
# Completed on Wed May 22 20:26:27 2024
# Generated by iptables-save v1.8.10 (nf_tables) on Wed May 22 20:26:27 2024
*filter
:INPUT ACCEPT [21432:1751797]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [18585:23591382]
:LIBVIRT_FWI - [0:0]
:LIBVIRT_FWO - [0:0]
:LIBVIRT_FWX - [0:0]
:LIBVIRT_INP - [0:0]
:LIBVIRT_OUT - [0:0]
-A INPUT -j LIBVIRT_INP
-A FORWARD -j LIBVIRT_FWX
-A FORWARD -j LIBVIRT_FWI
-A FORWARD -j LIBVIRT_FWO
-A OUTPUT -j LIBVIRT_OUT
-A LIBVIRT_FWI -d 10.17.4.0/24 -o virbr1 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A LIBVIRT_FWI -o virbr1 -j REJECT --reject-with icmp-port-unreachable
-A LIBVIRT_FWI -d 10.17.3.0/24 -o virbr0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A LIBVIRT_FWI -o virbr0 -j REJECT --reject-with icmp-port-unreachable
-A LIBVIRT_FWO -s 10.17.4.0/24 -i virbr1 -j ACCEPT
-A LIBVIRT_FWO -i virbr1 -j REJECT --reject-with icmp-port-unreachable
-A LIBVIRT_FWO -s 10.17.3.0/24 -i virbr0 -j ACCEPT
-A LIBVIRT_FWO -i virbr0 -j REJECT --reject-with icmp-port-unreachable
-A LIBVIRT_FWX -i virbr1 -o virbr1 -j ACCEPT
-A LIBVIRT_FWX -i virbr0 -o virbr0 -j ACCEPT
-A LIBVIRT_INP -i virbr1 -p udp -m udp --dport 53 -j ACCEPT
-A LIBVIRT_INP -i virbr1 -p tcp -m tcp --dport 53 -j ACCEPT
-A LIBVIRT_INP -i virbr1 -p udp -m udp --dport 67 -j ACCEPT
-A LIBVIRT_INP -i virbr1 -p tcp -m tcp --dport 67 -j ACCEPT
-A LIBVIRT_INP -i virbr0 -p udp -m udp --dport 53 -j ACCEPT
-A LIBVIRT_INP -i virbr0 -p tcp -m tcp --dport 53 -j ACCEPT
-A LIBVIRT_INP -i virbr0 -p udp -m udp --dport 67 -j ACCEPT
-A LIBVIRT_INP -i virbr0 -p tcp -m tcp --dport 67 -j ACCEPT
-A LIBVIRT_OUT -o virbr1 -p udp -m udp --dport 53 -j ACCEPT
-A LIBVIRT_OUT -o virbr1 -p tcp -m tcp --dport 53 -j ACCEPT
-A LIBVIRT_OUT -o virbr1 -p udp -m udp --dport 68 -j ACCEPT
-A LIBVIRT_OUT -o virbr1 -p tcp -m tcp --dport 68 -j ACCEPT
-A LIBVIRT_OUT -o virbr0 -p udp -m udp --dport 53 -j ACCEPT
-A LIBVIRT_OUT -o virbr0 -p tcp -m tcp --dport 53 -j ACCEPT
-A LIBVIRT_OUT -o virbr0 -p udp -m udp --dport 68 -j ACCEPT
-A LIBVIRT_OUT -o virbr0 -p tcp -m tcp --dport 68 -j ACCEPT
COMMIT
# Completed on Wed May 22 20:26:27 2024
# Generated by iptables-save v1.8.10 (nf_tables) on Wed May 22 20:26:27 2024
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:LIBVIRT_PRT - [0:0]
-A POSTROUTING -j LIBVIRT_PRT
-A LIBVIRT_PRT -s 10.17.4.0/24 -d 224.0.0.0/24 -j RETURN
-A LIBVIRT_PRT -s 10.17.4.0/24 -d 255.255.255.255/32 -j RETURN
-A LIBVIRT_PRT -s 10.17.4.0/24 ! -d 10.17.4.0/24 -p tcp -j MASQUERADE --to-ports 1024-65535
-A LIBVIRT_PRT -s 10.17.4.0/24 ! -d 10.17.4.0/24 -p udp -j MASQUERADE --to-ports 1024-65535
-A LIBVIRT_PRT -s 10.17.4.0/24 ! -d 10.17.4.0/24 -j MASQUERADE
-A LIBVIRT_PRT -s 10.17.3.0/24 -d 224.0.0.0/24 -j RETURN
-A LIBVIRT_PRT -s 10.17.3.0/24 -d 255.255.255.255/32 -j RETURN
-A LIBVIRT_PRT -s 10.17.3.0/24 ! -d 10.17.3.0/24 -p tcp -j MASQUERADE --to-ports 1024-65535
-A LIBVIRT_PRT -s 10.17.3.0/24 ! -d 10.17.3.0/24 -p udp -j MASQUERADE --to-ports 1024-65535
-A LIBVIRT_PRT -s 10.17.3.0/24 ! -d 10.17.3.0/24 -j MASQUERADE
COMMIT
# Completed on Wed May 22 20:26:27 2024

*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]

# Enmascaramiento para las redes NAT
-A POSTROUTING -s 10.17.3.0/24 -o enp3s0f1 -j MASQUERADE
-A POSTROUTING -s 10.17.4.0/24 -o enp3s0f1 -j MASQUERADE

COMMIT

*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]

# Permitir tráfico hacia y desde las redes NAT
-A FORWARD -i enp3s0f1 -o virbr0 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i enp3s0f1 -o virbr1 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i virbr0 -o enp3s0f1 -j ACCEPT
-A FORWARD -i virbr1 -o enp3s0f1 -j ACCEPT

# Permitir tráfico entre las redes NAT
-A FORWARD -i virbr0 -o virbr1 -j ACCEPT
-A FORWARD -i virbr1 -o virbr0 -j ACCEPT

COMMIT
Guardar y cerrar el archivo.

Habilitar y Arrancar el Servicio iptables
Recargar los archivos de configuración del sistema:

bash
Copiar código
sudo systemctl daemon-reload
Habilitar el servicio iptables para que se inicie al arranque:

bash
Copiar código
sudo systemctl enable iptables
Iniciar el servicio iptables:

bash
Copiar código
sudo systemctl start iptables
Verificación del Estado del Servicio iptables
Verificar el estado del servicio iptables:

bash
Copiar código
sudo systemctl status iptables
La salida debería mostrar que el servicio iptables está activo (exited) y se inició correctamente.

plaintext
Copiar código
● iptables.service - IPv4 firewall with iptables
     Loaded: loaded (/usr/lib/systemd/system/iptables.service; enabled; preset: disabled)
     Active: active (exited) since Wed 2024-05-22 23:01:38 CEST; 38min ago
    Process: 71989 ExecStart=/usr/libexec/iptables/iptables.init start (code=exited, status=0/SUCCESS)
   Main PID: 71989 (code=exited, status=0/SUCCESS)
        CPU: 27ms

may 22 23:01:38 server.cefas.com systemd[1]: Starting IPv4 firewall with iptables...
may 22 23:01:38 server.cefas.com iptables.init[71989]: iptables: Applying firewall rules: [  OK  ]
may 22 23:01:38 server.cefas.com systemd[1]: Finished IPv4 firewall with iptables.
Con estos pasos, has instalado y configurado correctamente el servicio iptables en tu sistema Rocky Linux 9.x. Ahora puedes administrar tus reglas de firewall de manera eficiente.